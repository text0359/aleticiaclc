<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora para Leticia ♡ com Extras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="top-action-buttons">
        <button id="darkModeToggle" class="action-button dark-mode-toggle-button" aria-label="Alternar modo escuro/claro">
            <i class="fas fa-moon"></i> </button>
        <button id="gamesTabButton" class="action-button games-tab-button" aria-label="Abrir central de jogos" onclick="toggleGamesModal()">
            <i class="fas fa-gamepad"></i>
        </button>
        <div id="dailyMessageIconContainer" class="action-button daily-message-icon-container" role="button" tabindex="0" aria-label="Abrir mensagem diária" onclick="toggleMessageModal()">
            <i class="fas fa-envelope-open-text"></i> 
            <span id="notificationBadge" class="notification-badge" style="display:none;" aria-hidden="true">!</span>
        </div>
    </div>


    <div id="dailyMessageModal" class="modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button class="close-button" onclick="toggleMessageModal()" aria-label="Fechar modal">&times;</button>
            <h2 id="modalTitle">Mensagem Especial para Você, Leticia <i class="fas fa-heart" style="color: #e91e63;"></i></h2>
            <div id="messageText" class="message-text-area" aria-live="polite">
                A carregar mensagem...
            </div>
            <div id="verseText" class="verse-text-area" aria-live="polite">
                A carregar versículo...
            </div>
            <div class="modal-actions">
                <button id="shareMessageButton" class="btn btn-share">
                    <i class="fas fa-share-alt"></i> Partilhar Mensagem
                </button>
                <span id="copiedMessage" class="copied-message-feedback" style="display:none;" aria-live="assertive">Copiado!</span>
            </div>
            <p class="message-source">Com carinho <i class="fas fa-smile-wink"></i></p>
        </div>
    </div>

    <div id="gamesModal" class="modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="gamesModalTitle">
        <div class="modal-content games-modal-content">
            <button class="close-button" onclick="toggleGamesModal()" aria-label="Fechar central de jogos">&times;</button>
            <h2 id="gamesModalTitle">Central de Jogos <i class="fas fa-dice-d6" style="color: #e91e63;"></i></h2>
            <div class="games-menu">
                <div class="game-menu-item" onclick="launchSnakeGame()" role="button" tabindex="0" aria-label="Jogar Jogo da Cobrinha">
                    <div class="game-info">
                        <i class="fas fa-ghost game-icon"></i> <span>Jogo da Cobrinha</span>
                    </div>
                    <i class="fas fa-play-circle play-indicator-icon"></i> </div>
                <div class="game-menu-item-disabled" aria-disabled="true">
                    <div class="game-info">
                        <i class="fas fa-puzzle-piece game-icon"></i>
                        <span>Jogo da Memória (Em breve!)</span>
                    </div>
                     <i class="fas fa-hourglass-half play-indicator-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="special-message">
        Para Leticia <i class="fas fa-heart" style="color: #e91e63;"></i>
    </div>

    <div class="calculator-container">
        <div id="display" class="display" role="textbox" aria-readonly="true" aria-label="Visor da calculadora">0</div>
        <div class="buttons">
            <button class="btn btn-clear" onclick="clearAll()">C</button>
            <button class="btn btn-del" onclick="deleteLast()">DEL</button>
            <button class="btn btn-operator" onclick="appendOperator('/')" aria-label="dividir">÷</button>
            <button class="btn btn-operator" onclick="appendOperator('*')" aria-label="multiplicar">×</button>

            <button class="btn" onclick="appendNumber('7')">7</button>
            <button class="btn" onclick="appendNumber('8')">8</button>
            <button class="btn" onclick="appendNumber('9')">9</button>
            <button class="btn btn-operator" onclick="appendOperator('-')" aria-label="subtrair">−</button>

            <button class="btn" onclick="appendNumber('4')">4</button>
            <button class="btn" onclick="appendNumber('5')">5</button>
            <button class="btn" onclick="appendNumber('6')">6</button>
            <button class="btn btn-operator" onclick="appendOperator('+')" aria-label="somar">+</button>

            <button class="btn" onclick="appendNumber('1')">1</button>
            <button class="btn" onclick="appendNumber('2')">2</button>
            <button class="btn" onclick="appendNumber('3')">3</button>
            <button class="btn btn-equals" onclick="calculateResult()" aria-label="igual">=</button>

            <button class="btn" onclick="appendNumber('0')" style="grid-column: span 2;">0</button>
            <button class="btn" onclick="appendDecimal()" aria-label="ponto decimal">.</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const appIdFromEnv = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-leticia-calculator';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let firebaseInitializedSuccessfully = false;

        function callStaticMessageFallback(reason) {
            console.warn(`[MÓDULO HTML] Fallback para mensagem estática devido a: ${reason}`);
            
            const attemptDisplayStatic = () => {
                if (typeof window.displayStaticMessage === 'function') {
                    console.log("[MÓDULO HTML] window.displayStaticMessage encontrada. A chamar...");
                    window.displayStaticMessage();
                } else {
                    console.error("[MÓDULO HTML] window.displayStaticMessage NÃO encontrada após espera. O script.js pode não ter sido carregado/executado a tempo, ou há um erro nele.");
                    const messageTextArea = document.getElementById('messageText');
                    const verseTextArea = document.getElementById('verseText');
                    if (messageTextArea) messageTextArea.textContent = "Erro ao carregar a mensagem do dia. Tente abrir novamente.";
                    if (verseTextArea) verseTextArea.textContent = "(Falha no carregamento da mensagem)";
                }
            };

            // Tenta chamar após um pequeno delay para dar hipótese ao script.js (com defer) de executar.
            // Se o DOM já estiver carregado, o setTimeout ainda ajuda a colocar na próxima volta do event loop.
            setTimeout(attemptDisplayStatic, 200); // Pequeno delay (200ms)
        }
        
        async function updateDynamicMessageDOM(msgData, dateString) {
            const messageTextArea = document.getElementById('messageText');
            const verseTextArea = document.getElementById('verseText');
            const notificationBadgeEl = document.getElementById('notificationBadge');

            if (!messageTextArea || !verseTextArea) {
                console.error("Elementos do modal de mensagem não encontrados para updateDynamicMessageDOM.");
                return;
            }

            messageTextArea.textContent = msgData.messageText || "Mensagem especial para você! ♡"; 
            
            verseTextArea.textContent = "A carregar versículo...";
            try {
                if (msgData.bibleVerseRef && typeof msgData.bibleVerseRef === 'string' && msgData.bibleVerseRef.trim() !== "" && typeof window.fetchVerseTextFromAPI === 'function') {
                    const fetchedVerseText = await window.fetchVerseTextFromAPI(msgData.bibleVerseRef);
                    verseTextArea.textContent = `${msgData.bibleVerseRef} - "${fetchedVerseText}"`;
                } else if (msgData.bibleVerseText && typeof msgData.bibleVerseText === 'string') { 
                    console.warn("Referência do versículo para API ausente/inválida ou função fetch não disponível. Usando texto de fallback do Gemini/Firestore.");
                    verseTextArea.textContent = `${msgData.bibleVerseRef || 'Versículo'} - "${msgData.bibleVerseText}"`;
                } else {
                    console.error("Nem referência válida para API nem texto de fallback do versículo disponíveis.");
                    verseTextArea.textContent = `${msgData.bibleVerseRef || 'Versículo'} (Texto indisponível)`;
                }
            } catch (error) {
                console.error(`Falha ao buscar versículo da API para mensagem dinâmica (${msgData.bibleVerseRef}). Usando fallback. Erro: ${error.message}`);
                if (msgData.bibleVerseText && typeof msgData.bibleVerseText === 'string' && msgData.bibleVerseText.trim() !== "") {
                    verseTextArea.textContent = `${msgData.bibleVerseRef || 'Versículo'} - "${msgData.bibleVerseText}" (API indisponível)`;
                } else {
                    verseTextArea.textContent = `${msgData.bibleVerseRef || 'Versículo'} (Não foi possível carregar o texto do versículo.)`;
                }
            }

            localStorage.setItem(`dynamicMessageLoaded_${dateString}`, 'true'); 
            const messageSeenKey = `messageSeen_${dateString}`;
            if (!localStorage.getItem(messageSeenKey)) {
                if (notificationBadgeEl) {
                    notificationBadgeEl.style.display = 'inline';
                    console.log(`Notificação ativada para mensagem dinâmica de ${dateString}.`);
                }
            } else {
                 if (notificationBadgeEl) notificationBadgeEl.style.display = 'none';
            }
        }

        if (!firebaseConfigFromEnv) {
            console.error("Configuração do Firebase (firebaseConfigFromEnv) não encontrada.");
            callStaticMessageFallback("Configuração do Firebase ausente no módulo.");
        } else {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigFromEnv);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                firebaseInitializedSuccessfully = true;
                console.log("Firebase inicializado com sucesso no módulo.");
            } catch (e) {
                console.error("Erro ao inicializar o Firebase no módulo:", e);
                callStaticMessageFallback(`Erro de inicialização do Firebase no módulo: ${e.message}`);
            }
        }

        if (firebaseInitializedSuccessfully) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Utilizador autenticado no módulo:", user.uid);
                    window.currentUserId = user.uid; 
                    await loadDailyMessage();
                } else {
                    console.log("Nenhum utilizador autenticado no módulo. A tentar login...");
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Login com token personalizado bem-sucedido no módulo.");
                        } catch (error) {
                            console.error("Erro no login com token personalizado no módulo, a tentar anónimo:", error);
                            try {
                                await signInAnonymously(auth);
                                console.log("Login anónimo bem-sucedido após falha no token no módulo.");
                            } catch (anonError) {
                                console.error("Falha no login anónimo também no módulo:", anonError);
                                callStaticMessageFallback("Falha completa na autenticação no módulo.");
                            }
                        }
                    } else {
                        try {
                            await signInAnonymously(auth);
                            console.log("Login anónimo bem-sucedido no módulo.");
                        } catch (anonError) {
                             console.error("Falha no login anónimo no módulo:", anonError);
                             callStaticMessageFallback("Falha na autenticação anónima no módulo.");
                        }
                    }
                }
            });
        } else {
             console.log("Firebase não foi inicializado com sucesso no módulo. A lógica de fallback para mensagens estáticas deve ser acionada (ou já foi).");
        }


        async function loadDailyMessage() {
            console.log("loadDailyMessage: Iniciando...");
            if (!db || !auth.currentUser) {
                callStaticMessageFallback("Firestore não disponível ou utilizador não autenticado para loadDailyMessage.");
                return;
            }

            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('dynamicMessageLoaded_') && key !== `dynamicMessageLoaded_${dateString}`) {
                    localStorage.removeItem(key);
                }
                 if (key.startsWith('messageSeen_') && key !== `messageSeen_${dateString}`) {
                    localStorage.removeItem(key);
                }
            });

            const messageDocRef = doc(db, `artifacts/${appIdFromEnv}/public/data/leticia_daily_messages/${dateString}`);
            
            try {
                const docSnap = await getDoc(messageDocRef);
                let messageData;

                if (docSnap.exists()) {
                    messageData = docSnap.data();
                    if (typeof messageData.messageText === 'undefined' || 
                        typeof messageData.bibleVerseRef === 'undefined' || 
                        typeof messageData.bibleVerseText === 'undefined') {
                        console.warn("Dados do Firestore incompletos ou com campos undefined. Removendo documento inválido e tentando gerar novo.", messageData);
                        await deleteDoc(messageDocRef); 
                        throw new Error("Dados do Firestore inválidos, forçando nova geração.");
                    }
                    console.log("Mensagem carregada do Firestore:", messageData);
                    await updateDynamicMessageDOM(messageData, dateString); 
                } else {
                    console.log("Nenhuma mensagem para hoje no Firestore. A tentar gerar com Gemini...");
                    try {
                        const prompt = `Gere uma mensagem de amor curta, original e inspiradora para Leticia. Inclua uma referência bíblica (ex: João 3:16) e o texto completo do versículo sobre amor, fé ou esperança. Formato JSON: {"message": "sua mensagem aqui", "verse_ref": "Livro X:Y", "verse_text": "texto do versículo aqui"}. Seja criativo e tocante.`;
                        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = { contents: chatHistory, generationConfig: { responseMimeType: "application/json" }};
                        const geminiApiKey = ""; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                        
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                        if (!response.ok) {
                            const errorResult = await response.json();
                            console.error("Erro da API Gemini:", errorResult);
                            throw new Error(`Falha ao gerar mensagem com Gemini: ${errorResult?.error?.message || response.statusText}`);
                        }
                        const result = await response.json();
                        
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                            const generatedJsonText = result.candidates[0].content.parts[0].text;
                            const cleanedJsonText = generatedJsonText.replace(/^```json\s*|```\s*$/g, '');
                            let parsedJson;
                            try {
                                parsedJson = JSON.parse(cleanedJsonText);
                            } catch (parseError) {
                                console.error("Erro ao fazer parse do JSON da API Gemini:", parseError, "JSON recebido:", cleanedJsonText);
                                throw new Error("Falha ao processar resposta da API Gemini (JSON inválido).");
                            }

                            const msgText = parsedJson.message;
                            const verseRef = parsedJson.verse_ref;
                            const verseTxt = parsedJson.verse_text;

                            if (typeof msgText === 'undefined' || typeof verseRef === 'undefined' || typeof verseTxt === 'undefined') {
                                console.error("Dados da API Gemini incompletos após parse:", parsedJson);
                                throw new Error("Dados da API Gemini incompletos (campos em falta após parse).");
                            }

                            messageData = {
                                messageText: msgText, 
                                bibleVerseRef: verseRef, 
                                bibleVerseText: verseTxt, 
                                generatedAt: serverTimestamp()
                            };
                            await setDoc(messageDocRef, messageData);
                            console.log("Nova mensagem Gemini guardada no Firestore:", messageData);
                            await updateDynamicMessageDOM(messageData, dateString); 
                        } else { 
                            throw new Error("Resposta da API Gemini não continha os dados esperados."); 
                        }
                    } catch (geminiError) {
                        console.error("Erro durante a tentativa com Gemini:", geminiError);
                        callStaticMessageFallback(`Falha na API Gemini: ${geminiError.message}`);
                    }
                }
            } catch (firestoreError) {
                console.error("Erro ao carregar ou processar mensagem do Firestore:", firestoreError);
                callStaticMessageFallback(`Falha no Firestore: ${firestoreError.message}`);
            }
        }
        window.loadDailyMessage = loadDailyMessage; 
    </script>
    <!-- O script.js com 'defer' será executado após o parse do HTML, mas antes do DOMContentLoaded.
         As funções globais definidas nele (como displayStaticMessage) devem estar disponíveis
         para o módulo acima quando este precisar delas (ex: no fallback). -->
    <script src="script.js" defer></script>
</body>
</html>
